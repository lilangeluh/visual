<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Visual Complexity & Word Memory</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html,body { margin:0; padding:0; height:100%; background:#111; color:#eee; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; }
    .screen { display:none; min-height:100vh; width:100vw; display:flex; align-items:center; justify-content:center; }
    .center { max-width: 760px; padding: 24px; line-height: 1.55; }
    .hint { font-size:14px; opacity:.85; margin-top:12px; }
    kbd { background:#222; border:1px solid #444; padding:2px 6px; border-radius:6px; }

    .trial-wrap {
      position:relative; width:100vw; height:100vh; display:flex; align-items:center; justify-content:center;
      background-size:cover; background-position:center; background-repeat:no-repeat;
    }
    .word-chip {
      font-weight: 800; letter-spacing:.02em;
      font-size: clamp(36px, 8vw, 72px);
      background: rgba(255,255,255,0.92); color:#111;
      padding: 12px 28px; border-radius: 16px; box-shadow: none;
      user-select:none;
    }
    .keys {
      position:absolute; bottom:20px; left:0; right:0;
      text-align:center; font-size:14px; opacity:.9; display:none;
    }
    a.hidden-download { display:none; }

    /* Simple list style for instruction bullets */
    ul { margin-left: 1.2rem; }
  </style>
</head>
<body>

<!-- Intro (global) -->
<div id="intro" class="screen" style="display:flex">
  <div class="center">
    <h2>Word Memory Task</h2>
    <p>You’ll do a short <b>practice</b> (study → test) and then the <b>main task</b>.</p>
    <ul>
      <li><b>Study:</b> words appear one at a time. Just <b>memorize</b> them.</li>
      <li><b>Test:</b> decide if each word is one you studied (<b>OLD</b>) or not (<b>NEW</b>).</li>
    </ul>
    <p class="hint">Press <kbd>Space</kbd> to continue.</p>
  </div>
</div>

<!-- Fullscreen prompt -->
<div id="fullscreenPrompt" class="screen">
  <div class="center">
    <h3>Before we begin</h3>
    <p>Please switch to fullscreen so nothing on your device covers the task.</p>
    <p class="hint">Press <kbd>Space</kbd> to enter fullscreen.</p>
  </div>
</div>

<!-- Practice study → mid → test -->
<div id="practiceStudyStart" class="screen">
  <div class="center">
    <h3>Practice — Study</h3>
    <p>Memorize each word. The screen advances automatically.</p>
    <p class="hint">Press <kbd>Space</kbd> to start practice study.</p>
  </div>
</div>

<div id="practiceMid" class="screen">
  <div class="center">
    <h3>Practice — Next Block</h3>
    <p>Another short set of words follows. Keep memorizing.</p>
    <p class="hint">Press <kbd>Space</kbd> to continue.</p>
  </div>
</div>

<div id="practiceTestInstr" class="screen">
  <div class="center">
    <h3>Practice — Test</h3>
    <p>For each word, respond:</p>
    <ul>
      <li><b><kbd>O</kbd> = OLD</b></li>
      <li><b><kbd>N</kbd> = NEW</b></li>
    </ul>
    <p class="hint">Press <kbd>Space</kbd> to begin the practice test.</p>
  </div>
</div>

<!-- Main study → mid → test instructions -->
<div id="mainStudyStart" class="screen">
  <div class="center">
    <h3>Main Task — Study</h3>
    <p>Memorize each word. The screen advances automatically.</p>
    <p class="hint">Press <kbd>Space</kbd> to start the main study.</p>
  </div>
</div>

<div id="mainMid" class="screen">
  <div class="center">
    <h3>Next Study Block</h3>
    <p>Another set of words follows. Keep memorizing.</p>
    <p class="hint">Press <kbd>Space</kbd> to continue.</p>
  </div>
</div>

<div id="mainTestInstr" class="screen">
  <div class="center">
    <h3>Main Task — Test</h3>
    <p>For each word, decide if it’s one you studied.</p>
    <ul>
      <li><b><kbd>O</kbd> = OLD</b></li>
      <li><b><kbd>N</kbd> = NEW</b></li>
    </ul>
    <p class="hint">Press <kbd>Space</kbd> to begin the main test.</p>
  </div>
</div>

<!-- Stage (shared display) -->
<div id="stage" class="screen">
  <div id="stageInner" class="trial-wrap">
    <div id="word" class="word-chip"></div>
    <div id="keysHint" class="keys">Press <b>O</b> for <b>OLD</b> • <b>N</b> for <b>NEW</b></div>
  </div>
</div>

<!-- Done -->
<div id="done" class="screen">
  <div class="center">
    <h2>All done — thank you!</h2>
    <p>Your data has been saved as a CSV download.</p>
    <p class="hint">If the file didn’t download, <a id="manualDl" href="#" download>click here</a>.</p>
  </div>
</div>
<a id="hiddenDl" class="hidden-download"></a>

<!-- Supabase client -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<script>
/* =========================
   CONFIG
   ========================= */
const IMG_PLAIN   = 'assets/plain.png';    // ensure these exist
const IMG_COMPLEX = 'assets/complex.png';

// Timing
const STUDY_WORD_MS = 1750;  // study exposure
const TEST_MAX_MS   = null;  // wait indefinitely for a response (no auto-skip)

// Keys
const KEY_OLD = 'o';
const KEY_NEW = 'n';

// Data columns (CSV order)
const KEEP_COLS = [
  'participant_id','order','phase','trial_in_phase','word','bgType','is_target',
  'response','correct','rt_ms','timestamp'
];

// ---- SUPABASE CONFIG ----
const SUPABASE_URL = "https://pafipawjgwvbwwzhfjoe.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBhZmlwYXdqZ3d2Ynd3emhmam9lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1OTA0MjEsImV4cCI6MjA3NzE2NjQyMX0.-bWNtXTZwVl2v14aOi_1huV72yIo_znZDOA6GaJRPTM";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* =========================
   MASTER WORD LISTS (original 20/20/40 trimmed to 15/15/30 at runtime)
   ========================= */
/* A (15) — six letters */
const MASTER_A = [
  'rabbit','window','garden','silver','ladder',
  'bottle','cookie','forest','pencil','mirror',
  'orange','tunnel','market','branch','drawer'
];
/* B (15) — six letters */
const MASTER_B = [
  'planet','castle','basket','engine','guitar',
  'pillow','button','pocket','string','camera',
  'circle','carpet','spring','office','school'
];
/* Lures (30) — six letters, no overlap with A/B */
const MASTER_LURES = [
  'butter','cheese','tomato','pepper','banana',
  'ticket','bridge','flight','rocket','helmet',
  'jungle','marble','needle','wallet','marker',
  'stream','flower','animal','fabric','powder',
  'desert','island','shovel','bucket','bakery',
  'statue','anchor','candle','letter','coffee'
];

/* =========================
   PRACTICE WORDS (short, distinct from main)
   ========================= */
const PRACTICE_A = ['maple','shelf'];
const PRACTICE_B = ['coin','river'];
const PRACTICE_LURES = ['torch','sketch'];

/* =========================
   UTILITIES
   ========================= */
const $ = sel => document.querySelector(sel);
const show = id => { for (const el of document.querySelectorAll('.screen')) el.style.display = 'none'; $(id).style.display = 'flex'; };

function uuid() {
  return 'xxxx-4xxx-yxxx-xxxx'.replace(/[xy]/g,c=>{
    const r=Math.random()*16|0, v=c==='x'?r:(r&0x3|0x8);
    return v.toString(16);
  });
}
function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; }
function sampleDown(arr, n){ const copy=[...arr]; shuffle(copy); return copy.slice(0, n); }
function nowISO(){ return new Date().toISOString(); }

function waitForSpace() {
  return new Promise(resolve => {
    function handler(e){
      if (e.code === 'Space' || e.key === ' ') {
        window.removeEventListener('keydown', handler);
        resolve();
      }
    }
    window.addEventListener('keydown', handler);
  });
}
function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

/* =========================
   STATE
   ========================= */
const PID   = uuid();
const ORDER = Math.random()<0.5 ? 'AB' : 'BA';  // AB: A=plain, B=complex; BA: A=complex, B=plain
const DATA  = []; // rows for main experiment only

// Main lists auto-downsize to 15/15/30 at runtime:
const LIST_A = sampleDown(MASTER_A, 15);
const LIST_B = sampleDown(MASTER_B, 15);
const LURES  = sampleDown(MASTER_LURES, 30);

/* =========================
   PRELOAD IMAGES
   ========================= */
function preloadImages(srcs){
  return Promise.all(srcs.map(src => new Promise(res => { const img=new Image(); img.onload=()=>res(); img.onerror=()=>res(); img.src=src; })));
}

/* =========================
   BUILDERS
   ========================= */
function buildStudyBlocks(order, listA, listB){
  const a_bg = (order==='AB') ? 'plain'   : 'complex';
  const b_bg = (order==='BA') ? 'complex' : 'plain';
  const blockA = shuffle(listA.map(w=>({word:w, bgType:a_bg})));
  const blockB = shuffle(listB.map(w=>({word:w, bgType:b_bg})));
  return { blockA, blockB };
}

function buildTestPool(order, listA, listB, lures){
  const map = new Map();
  if(order==='AB'){ listA.forEach(w=>map.set(w,'plain')); listB.forEach(w=>map.set(w,'complex')); }
  else            { listA.forEach(w=>map.set(w,'complex')); listB.forEach(w=>map.set(w,'plain'));  }
  const olds = [...listA, ...listB].map(w => ({ word:w, is_target:true,  study_bg: map.get(w) }));
  const news = lures.map(w => ({ word:w, is_target:false, study_bg:null }));
  return shuffle([...olds, ...news]);
}

/* =========================
   RENDER HELPERS
   ========================= */
function setBackground(type){
  const url = (type==='complex') ? IMG_COMPLEX : IMG_PLAIN;
  $('#stageInner').style.backgroundImage = `url("${url}")`;
}
function showWord(w){ $('#word').textContent = w; }
function showKeysHint(flag){ $('#keysHint').style.display = flag ? 'block' : 'none'; }

/* =========================
   CORE RUNNERS
   ========================= */
async function runStudyBlock(block, whichLabel, record){
  show('#stage');
  showKeysHint(false);
  for(let i=0;i<block.length;i++){
    const item = block[i];
    setBackground(item.bgType);
    showWord(item.word);

    if (record){
      DATA.push({
        participant_id: PID,
        order: ORDER,
        phase: 'study',
        trial_in_phase: `${whichLabel}:${i+1}`,
        word: item.word,
        bgType: item.bgType,
        is_target: null,
        response: null,
        correct: null,
        rt_ms: null,
        timestamp: nowISO()
      });
    }
    await sleep(STUDY_WORD_MS);
  }
}

async function runTest(testPool, record){
  setBackground('plain');     // neutral during test
  show('#stage');
  showKeysHint(true);

  for(let i=0;i<testPool.length;i++){
    const item = testPool[i];
    showWord(item.word);

    const rtStart = performance.now();
    const response = await waitForKey([KEY_OLD, KEY_NEW], TEST_MAX_MS);
    const rt = response ? Math.round(performance.now() - rtStart) : '';

    const saidOld = (response && response.toLowerCase()===KEY_OLD);
    const label   = response ? (saidOld ? 'OLD' : 'NEW') : 'NO_RESPONSE';
    const correct = response ? ((item.is_target && saidOld) || (!item.is_target && !saidOld)) : false;

    if (record){
      DATA.push({
        participant_id: PID,
        order: ORDER,
        phase: 'test',
        trial_in_phase: String(i+1),
        word: item.word,
        bgType: item.study_bg,     // 'plain' | 'complex' | null
        is_target: !!item.is_target,
        response: label,
        correct: !!correct,
        rt_ms: (rt === '' ? null : rt),
        timestamp: nowISO()
      });
    }
  }
}

function waitForKey(allowedKeys, timeoutMs = null){
  return new Promise(resolve=>{
    let done=false;
    function handler(e){
      const k=(e.key||'').toLowerCase();
      if(allowedKeys.includes(k)){
        done=true;
        window.removeEventListener('keydown', handler);
        if(timeoutId) clearTimeout(timeoutId);
        resolve(k);
      }
    }
    window.addEventListener('keydown', handler);

    let timeoutId=null;
    if (typeof timeoutMs === 'number' && isFinite(timeoutMs) && timeoutMs > 0){
      timeoutId = setTimeout(()=>{
        if(!done){
          window.removeEventListener('keydown', handler);
          resolve(null);
        }
      }, timeoutMs);
    }
  });
}

/* =========================
   EXPORT & UPLOAD
   ========================= */
function toCSV(rows){
  const header = KEEP_COLS.join(',');
  const esc = v => {
    if(v===null || v===undefined) return '';
    const s = String(v);
    return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
  };
  const body = rows.map(r => KEEP_COLS.map(k => esc(r[k])).join(',')).join('\n');
  return header + '\n' + body;
}

async function uploadToSupabase(rows) {
  try {
    const { data, error } = await supabase
      .from("vc_trials")
      .insert(rows);
    if (error) console.error("❌ Supabase upload error:", error.message);
    else console.log(`✅ Uploaded ${rows.length} rows to Supabase`);
  } catch (err) {
    console.error("❌ Network/upload failed:", err);
  }
}

async function finishAndDownload() {
  show("#done");
  await uploadToSupabase(DATA);

  // exit fullscreen politely
  if (document.fullscreenElement) {
    try { await document.exitFullscreen(); } catch(e) {}
  }

  const csv = toCSV(DATA);
  const blob = new Blob([csv], { type: "text/csv" });
  const url = URL.createObjectURL(blob);

  const a = document.getElementById("hiddenDl");
  a.href = url;
  a.download = `visual_complexity_${PID}.csv`;
  a.click();

  const manual = document.getElementById("manualDl");
  manual.href = url;
  manual.download = `visual_complexity_${PID}.csv`;

  console.log("✅ Data uploaded to Supabase and saved locally.");
}

/* =========================
   FLOW
   ========================= */
async function runAll(){
  // Intro
  show('#intro'); 
  await waitForSpace();

  // Fullscreen
  show('#fullscreenPrompt');
  await waitForSpace();
  if (document.documentElement.requestFullscreen) {
    try { await document.documentElement.requestFullscreen(); } catch(e) {}
  }

  await preloadImages([IMG_PLAIN, IMG_COMPLEX]);

  // PRACTICE (short; NOT recorded)
  show('#practiceStudyStart'); 
  await waitForSpace();
  {
    const practiceOrder = ORDER; // mirror main order
    const { blockA, blockB } = buildStudyBlocks(practiceOrder, PRACTICE_A, PRACTICE_B);
    await runStudyBlock(blockA, 'P-A', false);
    show('#practiceMid'); await waitForSpace();
    await runStudyBlock(blockB, 'P-B', false);

    show('#practiceTestInstr'); await waitForSpace();
    const pPool = buildTestPool(practiceOrder, PRACTICE_A, PRACTICE_B, PRACTICE_LURES);
    await runTest(pPool, false);
  }

  // MAIN — Study A + B
  show('#mainStudyStart'); 
  await waitForSpace();
  {
    const { blockA, blockB } = buildStudyBlocks(ORDER, LIST_A, LIST_B);
    await runStudyBlock(blockA, 'A', true);
    show('#mainMid'); await waitForSpace();
    await runStudyBlock(blockB, 'B', true);

    show('#mainTestInstr'); await waitForSpace();
    const testPool = buildTestPool(ORDER, LIST_A, LIST_B, LURES);
    await runTest(testPool, true);
  }

  // DONE
  await finishAndDownload();
}

/* =========================
   START
   ========================= */
runAll();
</script>
</body>
</html>